volumes:
  download:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DOWNLOAD_PATH}
    name: ${TANGO_APP_NAME}_download
  vault:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VAULT_PATH}
    name: ${TANGO_APP_NAME}_vault
  web_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WEB_PATH}
    name: ${TANGO_APP_NAME}_web_data
  tautulli_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${TAUTULLI_DATA_PATH}
    name: ${TANGO_APP_NAME}_tautulli_data
  newsletters_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${TAUTULLI_NEWSLETTERS_PATH}
    name: ${TANGO_APP_NAME}_newsletters_data
  organizr2_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ORGANIZR2_DATA_PATH}
    name: ${TANGO_APP_NAME}_organizr2_data
  organizrtest_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ORGANIZRTEST_DATA_PATH}
    name: ${TANGO_APP_NAME}_organizrtest_data
  plex_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PLEX_DATA_PATH}
    name: ${TANGO_APP_NAME}_plex_data
  mkvtoolnix_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MKVTOOLNIX_DATA_PATH}
    name: ${TANGO_APP_NAME}_mkvtoolnix_data
  jdownloader2_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${JDOWNLOADER2_DATA_PATH}
    name: ${TANGO_APP_NAME}_jdownloader2_data
  jdownloader2_download:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${JDOWNLOADER2_DOWNLOAD_PATH}
    name: ${TANGO_APP_NAME}_jdownloader2_download
  transmission_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${TRANSMISSION_DATA_PATH}
    name: ${TANGO_APP_NAME}_transmission_data
  transmission_download:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${TRANSMISSION_DOWNLOAD_PATH}
    name: ${TANGO_APP_NAME}_transmission_download
  transmission_watch:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VAULT_TORRENT_PATH}
    name: ${TANGO_APP_NAME}_transmission_watch
  nzbtomedia_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NZBTOMEDIA_DATA_PATH}
    name: ${TANGO_APP_NAME}_nzbtomedia_data
  booksonic_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BOOKSONIC_DATA_PATH}
    name: ${TANGO_APP_NAME}_booksonic_data
  ebooks_list_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${EBOOKS_LIST_DATA_PATH}
    name: ${TANGO_APP_NAME}_ebooks_list_data
  sabnzbd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SABNZBD_DATA_PATH}
    name: ${TANGO_APP_NAME}_sabnzbd_data
  lazylibrarian_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LAZYLIBRARIAN_DATA_PATH}
    name: ${TANGO_APP_NAME}_lazylibrarian_data
  calibre_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CALIBRE_DATA_PATH}
    name: ${TANGO_APP_NAME}_calibre_data
  calibreweb_books_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CALIBREWEB_BOOKS_DATA_PATH}
    name: ${TANGO_APP_NAME}_calibreweb_books_data
  calibredb_books_media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CALIBREDB_BOOKS_MEDIA_PATH}
    name: ${TANGO_APP_NAME}_calibredb_books_media
  calibreweb_press_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CALIBREWEB_PRESS_DATA_PATH}
    name: ${TANGO_APP_NAME}_calibreweb_press_data
  calibredb_press_media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CALIBREDB_PRESS_MEDIA_PATH}
    name: ${TANGO_APP_NAME}_calibredb_press_media



# NOTE : yaml do not support array merge, so we cannot factorize volume or labels declaration here
# https://forums.docker.com/t/is-there-any-way-to-use-extension-fields-in-docker-compose-with-docker-secrets/68602
# https://github.com/linuxserver/docker-calibre-web
# https://hub.docker.com/r/linuxserver/calibre-web
x-calibreweb: &default-calibreweb
  image: linuxserver/calibre-web:${CALIBREWEB_VERSION:-latest}
  depends_on:
    - service_init
  restart: unless-stopped
  networks:
    - default
  expose:
    - 8083


services:
  # NOTE : service_init will be merged with service_init from tango compose file
  service_init:
    volumes:
      - download:/download
     
  # Main mambo portal
  # https://github.com/Organizr/docker-organizr
  # https://github.com/causefx/Organizr
  # https://organizr.app/
  organizr2:
    image: organizr/organizr
    container_name: ${TANGO_APP_NAME}_organizr2
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain organizr2 configuration
      - organizr2_data:/config
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      # use 'manual' as branch value to disable code update installed into /config folder
      - branch=${ORGANIZR2_BRANCH:-v2-master}
      - fpm=true
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.organizr2.loadbalancer.server.port=80"
      - "traefik.http.services.organizr2.loadbalancer.server.scheme=http"
      - "traefik.http.services.organizr2.loadbalancer.passhostheader=true"
      # middlewares
      # X-Frame-Options: allow-from * is DEPRECATED
      # force request to return X-Frame-Options: allow-from * - can be used to force service to show into an organizr iframe even if they do not allow it
      #- 'traefik.http.middlewares.xframe-allow-all.headers.customFrameOptionsValue=allow-from *'
      # enpty any X-Frame-Options instead
      - 'traefik.http.middlewares.xframe-allow-all.headers.customResponseHeaders.X-Frame-Options='
      # routers
      - "traefik.http.routers.organizr2.entrypoints=${ORGANIZR2_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.organizr2.rule=HostRegexp(`{subdomain:${ORGANIZR2_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.organizr2.service=organizr2"
      - "traefik.http.routers.organizr2.priority=${ORGANIZR2_PRIORITY}"
      - "traefik.http.routers.organizr2-secure.entrypoints=${ORGANIZR2_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.organizr2-secure.rule=HostRegexp(`{subdomain:${ORGANIZR2_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.organizr2-secure.priority=${ORGANIZR2_PRIORITY}"
      - "traefik.http.routers.organizr2-secure.service=organizr2"
      - "traefik.http.routers.organizr2-secure.tls=true"
      - "traefik.http.routers.organizr2-secure.tls.domains[0].main=${ORGANIZR2_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.organizr2.middlewares=error-middleware"
      - "traefik.http.routers.organizr2-secure.middlewares=error-middleware"
      # BEGIN SPECIAL tip -------------------------------------------------------------------------------------
      # make organizr plex SSO work : have another way to access plex as a subfolder of organizr2 dns name
      # middlewares
      - "traefik.http.middlewares.organizr2_plex-stripprefix.stripprefix.prefixes=/plex, /plex/"
      # routers
      - "traefik.http.routers.organizr2_plex.entrypoints=${ORGANIZR2_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.organizr2_plex.rule=HostRegexp(`{subdomain:${ORGANIZR2_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && (PathPrefix(`/plex`) || PathPrefix(`/web`))"
      - "traefik.http.routers.organizr2_plex.service=plex"
      # organizr2_plex is declared as a tango subservice, which have higher priority than their relative parent (organizr2 router here)
      - "traefik.http.routers.organizr2_plex.priority=${ORGANIZR2_PLEX_PRIORITY}"
      - "traefik.http.routers.organizr2_plex-secure.entrypoints=${ORGANIZR2_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.organizr2_plex-secure.rule=HostRegexp(`{subdomain:${ORGANIZR2_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && (PathPrefix(`/plex`) || PathPrefix(`/web`))"
      - "traefik.http.routers.organizr2_plex-secure.priority=${ORGANIZR2_PLEX_PRIORITY}"
      - "traefik.http.routers.organizr2_plex-secure.service=plex"
      - "traefik.http.routers.organizr2_plex-secure.tls=true"
      - "traefik.http.routers.organizr2_plex-secure.tls.domains[0].main=${ORGANIZR2_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # add plex-auth to authorize access to these url http://organizr2.domain.com/plex http://organizr2.domain.com/web only after logged into organizr
      - "traefik.http.routers.organizr2_plex.middlewares=organizr2_plex-stripprefix,plex-auth@rest"
      - "traefik.http.routers.organizr2_plex-secure.middlewares=organizr2_plex-stripprefix,plex-auth@rest"
      # NOTE : do not activate error-middleware, if so plex service will cannot ask for authentification
      # - "traefik.http.routers.organizr2_plex.middlewares=organizr2_plex-stripprefix,plex-auth@rest,error-middleware"
      # - "traefik.http.routers.organizr2_plex-secure.middlewares=organizr2_plex-stripprefix,plex-auth@rest,error-middleware"
      # END SPECIAL tip -------------------------------------------------------------------------------------
    networks:
      - default
    expose:
      - 80
  organizrtest:
    image: ghcr.io/organizr/organizr
    container_name: ${TANGO_APP_NAME}_organizrtest
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain configuration
      - organizrtest_data:/config
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      # use 'manual' as branch value to disable code update installed into /config folder
      - branch=${ORGANIZRTEST_BRANCH:-v2-master}
      - fpm=true
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.organizrtest.loadbalancer.server.port=80"
      - "traefik.http.services.organizrtest.loadbalancer.server.scheme=http"
      - "traefik.http.services.organizrtest.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.organizrtest.entrypoints=${ORGANIZRTEST_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.organizrtest.rule=HostRegexp(`{subdomain:${ORGANIZRTEST_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.organizrtest.service=organizrtest"
      - "traefik.http.routers.organizrtest.priority=${ORGANIZRTEST_PRIORITY:-}"
      - "traefik.http.routers.organizrtest-secure.entrypoints=${ORGANIZRTEST_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.organizrtest-secure.rule=HostRegexp(`{subdomain:${ORGANIZRTEST_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.organizrtest-secure.priority=${ORGANIZRTEST_PRIORITY:-}"
      - "traefik.http.routers.organizrtest-secure.service=organizrtest"
      - "traefik.http.routers.organizrtest-secure.tls=true"
      - "traefik.http.routers.organizrtest-secure.tls.domains[0].main=${ORGANIZRTEST_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.organizrtest.middlewares=error-middleware"
      - "traefik.http.routers.organizrtest-secure.middlewares=error-middleware"
    networks:
      - default
    expose:
      - 80
  # Plex statistics and management tools
  # https://github.com/Tautulli/Tautulli
  # https://hub.docker.com/r/linuxserver/tautulli
  # https://github.com/linuxserver/docker-tautulli
  tautulli:
    image: ghcr.io/linuxserver/tautulli:${TAUTULLI_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_tautulli
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # data/tautulli will contain tautulli configuration
      - tautulli_data:/config
      # newsletter templates
      - ebooks_list_data:/custom_template
      - ${TANGO_APP_ROOT}/pool/ebooks:/default_template:ro
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.tautulli.loadbalancer.server.port=8181"
      - "traefik.http.services.tautulli.loadbalancer.server.scheme=http"
      - "traefik.http.services.tautulli.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.tautulli.entrypoints=${TAUTULLI_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.tautulli.rule=HostRegexp(`{subdomain:${TAUTULLI_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.tautulli.priority=${TAUTULLI_PRIORITY}"
      - "traefik.http.routers.tautulli.service=tautulli"
      - "traefik.http.routers.tautulli-secure.entrypoints=${TAUTULLI_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.tautulli-secure.rule=HostRegexp(`{subdomain:${TAUTULLI_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.tautulli-secure.priority=${TAUTULLI_PRIORITY}"
      - "traefik.http.routers.tautulli-secure.service=tautulli"
      - "traefik.http.routers.tautulli-secure.tls=true"
      - "traefik.http.routers.tautulli-secure.tls.domains[0].main=${TAUTULLI_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.tautulli.middlewares=tautulli-auth@rest,error-middleware"
      - "traefik.http.routers.tautulli-secure.middlewares=tautulli-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 8181


  # Manage movie/tv show requests
  ombi:
    image: studioetrange/docker-ombi:${OMBI_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_ombi
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # data/ombi will contain ombi configuration
      - data:/data
    environment:
      - SERVICE_USER=${TANGO_USER_ID:-0}:${TANGO_GROUP_ID:-0}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.ombi.loadbalancer.server.port=5000"
      - "traefik.http.services.ombi.loadbalancer.server.scheme=http"
      - "traefik.http.services.ombi.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.ombi.entrypoints=${OMBI_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.ombi.rule=HostRegexp(`{subdomain:${OMBI_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.ombi.priority=${OMBI_PRIORITY}"
      - "traefik.http.routers.ombi.service=ombi"
      - "traefik.http.routers.ombi-secure.entrypoints=${OMBI_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.ombi-secure.rule=HostRegexp(`{subdomain:${OMBI_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.ombi-secure.priority=${OMBI_PRIORITY}"
      - "traefik.http.routers.ombi-secure.service=ombi"
      - "traefik.http.routers.ombi-secure.tls=true"
      - "traefik.http.routers.ombi-secure.tls.domains[0].main=${OMBI_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.ombi.middlewares=ombi-auth@rest,error-middleware"
      - "traefik.http.routers.ombi-secure.middlewares=ombi-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 5000
    build:
      context: https://github.com/StudioEtrange/docker-ombi.git#:ver/${OMBI_VERSION:-latest}


  # Newzgroup downloader
  # https://hub.docker.com/r/hotio/sabnzbd
  # https://github.com/hotio/sabnzbd
  # TODO BUG : /config/.cache should not be here and do not have right owner/permission
  #      cannnot use linuxserver/sabnzbd while https://github.com/linuxserver/docker-sabnzbd/issues/94
  # https://hub.docker.com/r/linuxserver/sabnzbd/
  # https://github.com/linuxserver/docker-sabnzbd
  # https://sabnzbd.org/
  sabnzbd:
    #image: ghcr.io/linuxserver/sabnzbd:${SABNZBD_VERSION:-latest}
    image: hotio/sabnzbd:release-3.1.1
    container_name: ${TANGO_APP_NAME}_sabnzbd
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # data/sabnzbd will contain sabnzbd configuration
      - sabnzbd_data:/config
      # different paths used by sabnzbd
      - download:/download
      - vault:/vault
      - nzbtomedia_data:/scripts
      #- artefact:${TANGO_ARTEFACT_MOUNT_POINT:-/artefact}
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - DEBUG=yes
      #- UMASK=002
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.sabnzbd.loadbalancer.server.port=8080"
      - "traefik.http.services.sabnzbd.loadbalancer.server.scheme=http"
      - "traefik.http.services.sabnzbd.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.sabnzbd.entrypoints=${SABNZBD_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.sabnzbd.rule=HostRegexp(`{subdomain:${SABNZBD_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.sabnzbd.priority=${SABNZBD_PRIORITY}"
      - "traefik.http.routers.sabnzbd.service=sabnzbd"
      - "traefik.http.routers.sabnzbd-secure.entrypoints=${SABNZBD_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.sabnzbd-secure.rule=HostRegexp(`{subdomain:${SABNZBD_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.sabnzbd-secure.priority=${SABNZBD_PRIORITY}"
      - "traefik.http.routers.sabnzbd-secure.service=sabnzbd"
      - "traefik.http.routers.sabnzbd-secure.tls=true"
      - "traefik.http.routers.sabnzbd-secure.tls.domains[0].main=${SABNZBD_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.sabnzbd.middlewares=xframe-allow-all,sabnzbd-auth@rest,error-middleware"
      - "traefik.http.routers.sabnzbd-secure.middlewares=xframe-allow-all,sabnzbd-auth@rest,error-middleware"
      # subservice sabnzbd_api routers
      - "traefik.http.routers.sabnzbd_api.entrypoints=${SABNZBD_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.sabnzbd_api.rule=HostRegexp(`{subdomain:${SABNZBD_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && Query(`apikey=${SABNZBD_API_KEY:-}`)"
      - "traefik.http.routers.sabnzbd_api.priority=${SABNZBD_API_PRIORITY}"
      - "traefik.http.routers.sabnzbd_api.service=sabnzbd"
      - "traefik.http.routers.sabnzbd_api-secure.entrypoints=${SABNZBD_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.sabnzbd_api-secure.rule=HostRegexp(`{subdomain:${SABNZBD_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && Query(`apikey=${SABNZBD_API_KEY:-}`)"
      - "traefik.http.routers.sabnzbd_api-secure.priority=${SABNZBD_API_PRIORITY}"
      - "traefik.http.routers.sabnzbd_api-secure.service=sabnzbd"
      - "traefik.http.routers.sabnzbd_api-secure.tls=true"
      - "traefik.http.routers.sabnzbd_api-secure.tls.domains[0].main=${SABNZBD_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # subservice sabnzbd_api routers middleware
      - "traefik.http.routers.sabnzbd_api.middlewares=error-middleware"
      - "traefik.http.routers.sabnzbd_api-secure.middlewares=error-middleware"
    networks:
      - default
    expose:
      - 8080
      # HTTPS port
      - 8081


  # nzbtomedia : sync nzb software
  # https://github.com/clinton-hall/nzbToMedia
  nzbtomedia:
    image: studioetrange/nzbtomedia:latest
    container_name: ${TANGO_APP_NAME}_nzbtomedia
    depends_on:
      - service_init
    volumes:
      # data/nzbtomedia will contain nzbtomedia
      - nzbtomedia_data:/app
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - VERSION=${NZBTOMEDIA_VERSION:-master}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
    networks:
      - default
    build:
      context: ./pool/artefacts/docker-nzbtomedia


  # Media server
  plex:
    image: plexinc/pms-docker:${PLEX_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_plex
    # add a DNS entry to the existing 'plex' entry only inside this container
    # the default plex server name is defined by the hostname
    hostname: mambo
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain plex configuration
      - plex_data:/config
      #- artefact:${TANGO_ARTEFACT_MOUNT_POINT:-/artefact}
      - ${PLEX_TRANSCODE_PATH}:/transcode
    environment:
      - PLEX_UID=${TANGO_USER_ID:-0}
      - PLEX_GID=${TANGO_GROUP_ID:-0}
      - CHANGE_CONFIG_DIR_OWNERSHIP=true
      # if server have already be claimed, PLEX_CLAIM env var is ignored
      - PLEX_CLAIM=${PLEX_CLAIM:-}
      - 'ADVERTISE_IP=http://${TANGO_HOSTNAME}:${PLEX_DIRECT_ACCESS_PORT}/,https://${TANGO_HOSTNAME}:${PLEX_DIRECT_ACCESS_PORT}/,http://plex:${NETWORK_PORT_MAIN}/,https://plex:${NETWORK_PORT_MAIN_SECURE}/,http://plex:${NETWORK_PORT_SECONDARY}/,https://plex:${NETWORK_PORT_SECONDARY_SECURE}/,http://plex.${TANGO_DOMAIN}:${NETWORK_PORT_MAIN}/,https://plex.${TANGO_DOMAIN}:${NETWORK_PORT_MAIN_SECURE}/,http://plex.${TANGO_DOMAIN}:${NETWORK_PORT_SECONDARY}/,https://plex.${TANGO_DOMAIN}:${NETWORK_PORT_SECONDARY_SECURE}/,http://${TANGO_HOSTNAME}.${TANGO_DOMAIN}:${NETWORK_PORT_MAIN}/,https://${TANGO_HOSTNAME}.${TANGO_DOMAIN}:${NETWORK_PORT_MAIN_SECURE}/,http://${TANGO_HOSTNAME}.${TANGO_DOMAIN}:${NETWORK_PORT_SECONDARY}/,https://${TANGO_HOSTNAME}.${TANGO_DOMAIN}:${NETWORK_PORT_SECONDARY_SECURE}/,${PLEX_ADDITIONAL_DOMAIN}'
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.plex.loadbalancer.server.port=32400"
      - "traefik.http.services.plex.loadbalancer.server.scheme=http"
      - "traefik.http.services.plex.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.plex.entrypoints=${PLEX_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.plex.rule=HostRegexp(`{subdomain:${PLEX_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.plex.priority=${PLEX_PRIORITY}"
      - "traefik.http.routers.plex.service=plex"
      - "traefik.http.routers.plex-secure.entrypoints=${PLEX_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.plex-secure.rule=HostRegexp(`{subdomain:${PLEX_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.plex-secure.priority=${PLEX_PRIORITY}"
      - "traefik.http.routers.plex-secure.service=plex"
      - "traefik.http.routers.plex-secure.tls=true"
      - "traefik.http.routers.plex-secure.tls.domains[0].main=${PLEX_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      # NOTE : do not activate error-middleware, if so plex service will cannot ask for authentification
      #- "traefik.http.routers.plex.middlewares=error-middleware"
      #- "traefik.http.routers.plex-secure.middlewares=error-middleware"
    networks:
      - default
    expose:
      - 33400/tcp
      - 32400/tcp
      - 3005/tcp
      - 8324/tcp
      - 32469/tcp
      - 1900/udp
      - 32410/udp
      - 32412/udp
      - 32413/udp
      - 32414/udp


  # Tv show download manager
  medusa:
    image: studioetrange/docker-medusa:${MEDUSA_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_medusa
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # data/medusa will contain medusa configuration
      - data:/data
      # different paths used by medusa
      - download:/download
      #- artefact:${TANGO_ARTEFACT_MOUNT_POINT:-/artefact}
    environment:
      - SERVICE_USER=${TANGO_USER_ID:-0}:${TANGO_GROUP_ID:-0}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.medusa.loadbalancer.server.port=8081"
      - "traefik.http.services.medusa.loadbalancer.server.scheme=http"
      - "traefik.http.services.medusa.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.medusa.entrypoints=${MEDUSA_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.medusa.rule=HostRegexp(`{subdomain:${MEDUSA_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.medusa.priority=${MEDUSA_PRIORITY}"
      - "traefik.http.routers.medusa.service=medusa"
      - "traefik.http.routers.medusa-secure.entrypoints=${MEDUSA_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.medusa-secure.rule=HostRegexp(`{subdomain:${MEDUSA_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.medusa-secure.priority=${MEDUSA_PRIORITY}"
      - "traefik.http.routers.medusa-secure.service=medusa"
      - "traefik.http.routers.medusa-secure.tls=true"
      - "traefik.http.routers.medusa-secure.tls.domains[0].main=${MEDUSA_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.medusa.middlewares=medusa-auth@rest,error-middleware"
      - "traefik.http.routers.medusa-secure.middlewares=medusa-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 8081
    build:
      context: https://github.com/StudioEtrange/docker-medusa.git#:ver/${MEDUSA_VERSION:-latest}
  # MKVToolNix is a set of tools to create, alter and inspect mkv files.
  # NOTE : VNC port is not open here
  # https://hub.docker.com/r/jlesage/mkvtoolnix
  # https://github.com/jlesage/docker-mkvtoolnix
  mkvtoolnix:
    image: jlesage/mkvtoolnix:${MKVTOOLNIX_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_mkvtoolnix
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain mkvtoolnix configuration
      - mkvtoolnix_data:/config
      # different paths used by mkvtoolnix
      - download:/download
      #- artefact:${TANGO_ARTEFACT_MOUNT_POINT:-/artefact}
    environment:
      - USER_ID=${TANGO_USER_ID:-0}
      - GROUP_ID=${TANGO_GROUP_ID:-0}
      - KEEP_APP_RUNNING=1
      - DISPLAY_WIDTH=${MKVTOOLNIX_WIDTH:-1280}
      - DISPLAY_HEIGHT=${MKVTOOLNIX_HEIGHT-:768}
      - SECURE_CONNECTION=0
      - CLEAN_TMP_DIR=1
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.mkvtoolnix.loadbalancer.server.port=5800"
      - "traefik.http.services.mkvtoolnix.loadbalancer.server.scheme=http"
      - "traefik.http.services.mkvtoolnix.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.mkvtoolnix.entrypoints=${MKVTOOLNIX_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.mkvtoolnix.rule=HostRegexp(`{subdomain:${MKVTOOLNIX_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.mkvtoolnix.priority=${MKVTOOLNIX_PRIORITY}"
      - "traefik.http.routers.mkvtoolnix.service=mkvtoolnix"
      - "traefik.http.routers.mkvtoolnix-secure.entrypoints=${MKVTOOLNIX_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.mkvtoolnix-secure.rule=HostRegexp(`{subdomain:${MKVTOOLNIX_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.mkvtoolnix-secure.priority=${MKVTOOLNIX_PRIORITY}"
      - "traefik.http.routers.mkvtoolnix-secure.service=mkvtoolnix"
      - "traefik.http.routers.mkvtoolnix-secure.tls=true"
      - "traefik.http.routers.mkvtoolnix-secure.tls.domains[0].main=${MKVTOOLNIX_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.mkvtoolnix.middlewares=mkvtoolnix-auth@rest,error-middleware"
      - "traefik.http.routers.mkvtoolnix-secure.middlewares=mkvtoolnix-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 5800/tcp


  # https://github.com/linuxserver/docker-transmission
  # NOTE : there is 2 subservices transmission_internal and transmission_external which wrap transmission webui and rpc
  #     transmission_internal (http://internal-transmission.domain.com) is protected by organizr auth and will auto login with transmission auth basic --> Use this from portal access (organizr)
  #               if organizr auth is disabled, this subservices will have auto login disabled
  #     transmission_external (http://transmission.domain.com) is NOT protected by organizr auth and need a basic authentification --> Use this for api access with 3rd tool
  #                                                         tested with chrome "Transmission easy client"
  # NOTE : we can not use an errormiddleware because at first request on /transmission/rpc, server respond a 409 AND a special header and the client must retry, an error middleware will cancel the retry !
  transmission:
    # TODO wait for PRs hhttps://github.com/linuxserver/docker-transmission/pull/146
    #image: ghcr.io/linuxserver/transmission:version-3.00-r0
    #${TRANSMISSION_VERSION:-latest}
    image: studioetrange/transmission:latest
    container_name: ${TANGO_APP_NAME}_transmission
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      - transmission_data:/config
      - transmission_download:/downloads
      - transmission_watch:/watch
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - TRANSMISSION_WEB_HOME=${TRANSMISSION_UI}
      - USER=${TRANSMISSION_USER:-}
      - PASS=${TRANSMISSION_PASSWORD:-}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service transmission
      # transmission port for rpc and webui : 9091
      - "traefik.http.services.transmission.loadbalancer.server.port=9091"
      - "traefik.http.services.transmission.loadbalancer.server.scheme=http"
      - "traefik.http.services.transmission.loadbalancer.passhostheader=true"
      # this middleware is used to auto login into transmission
      - 'traefik.http.middlewares.transmission-autoauthbasic.headers.customrequestheaders.Authorization=Basic ${TRANSMISSION_AUTH_BASIC}'
      # transmission have a lot of problem with url endpoint and HTTP error 409, we need to add /
      - 'traefik.http.middlewares.transmission-slash1.redirectregex.regex=^(https?://[^/]+/transmission/web)$$'
      - 'traefik.http.middlewares.transmission-slash1.redirectregex.replacement=$${1}/'
      - 'traefik.http.middlewares.transmission-slash2.redirectregex.regex=^(https?://[^/]+/transmission/rpc)$$'
      - 'traefik.http.middlewares.transmission-slash2.redirectregex.replacement=$${1}/'
      # sub service transmission_internal
      - "traefik.http.routers.transmission_internal.entrypoints=${TRANSMISSION_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.transmission_internal.rule=HostRegexp(`{subdomain:internal-${TRANSMISSION_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.transmission_internal.priority=${TRANSMISSION_INTERNAL_PRIORITY}"
      - "traefik.http.routers.transmission_internal.service=transmission"
      - "traefik.http.routers.transmission_internal-secure.entrypoints=${TRANSMISSION_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.transmission_internal-secure.rule=HostRegexp(`{subdomain:internal-${TRANSMISSION_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.transmission_internal-secure.priority=${TRANSMISSION_INTERNAL_PRIORITY}"
      - "traefik.http.routers.transmission_internal-secure.service=transmission"
      - "traefik.http.routers.transmission_internal-secure.tls=true"
      - "traefik.http.routers.transmission_internal-secure.tls.domains[0].main=internal-${TRANSMISSION_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      - "traefik.http.routers.transmission_internal.middlewares=transmission-auth@rest,transmission-slash1,transmission-slash2,transmission-autoauthbasic"
      #- "traefik.http.routers.transmission_internal.middlewares=transmission-auth@rest,transmission-authbasic,error-middleware"
      - "traefik.http.routers.transmission_internal-secure.middlewares=transmission-auth@rest,transmission-slash1,transmission-slash2,transmission-autoauthbasic"
      #- "traefik.http.routers.transmission_internal-secure.middlewares=transmission-auth@rest,transmission-authbasic,error-middleware"
      # sub service transmission_external
      - "traefik.http.routers.transmission_external.entrypoints=${TRANSMISSION_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.transmission_external.rule=HostRegexp(`{subdomain:${TRANSMISSION_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.transmission_external.priority=${TRANSMISSION_EXTERNAL_PRIORITY}"
      - "traefik.http.routers.transmission_external.service=transmission"
      - "traefik.http.routers.transmission_external-secure.entrypoints=${TRANSMISSION_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.transmission_external-secure.rule=HostRegexp(`{subdomain:${TRANSMISSION_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.transmission_external-secure.priority=${TRANSMISSION_EXTERNAL_PRIORITY}"
      - "traefik.http.routers.transmission_external-secure.service=transmission"
      - "traefik.http.routers.transmission_external-secure.tls=true"
      - "traefik.http.routers.transmission_external-secure.tls.domains[0].main=${TRANSMISSION_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      - "traefik.http.routers.transmission_external.middlewares=transmission-slash1,transmission-slash2"
      - "traefik.http.routers.transmission_external-secure.middlewares=transmission-slash1,transmission-slash2"
    networks:
      - default
    expose:
      - 51413/tcp
      - 51413/udp
    ports:
      - ${TRANSMISSION_PORT}:51413/tcp
      - ${TRANSMISSION_PORT}:51413/udp
    build:
      context: https://github.com/StudioEtrange/docker-transmission.git#master


  # https://github.com/jlesage/docker-makemkv
  # # NOTE : VNC not open
  # makemkv:
  #   image: jlesage/makemkv:${MAKEMKV_VERSION:-latest}
  #   container_name: ${TANGO_APP_NAME}_makemkv
  #   depends_on:
  #     - service_init
  #   restart: unless-stopped
  #   volumes:
  #     # will contain makemkv configuration
  #     - makemkv_data:/config
  #     # different paths used by makemkv
  #     - download:/download
  #     - artefact:${TANGO_ARTEFACT_MOUNT_POINT:-/artefact}
  #     - /dev/shm:/dev/shm
  #   environment:
  #     - USER_ID=${TANGO_USER_ID:-0}
  #     - GROUP_ID=${TANGO_GROUP_ID:-0}
  #     - KEEP_APP_RUNNING=1
  #     - DISPLAY_WIDTH=${MAKEMKV_WIDTH:-1280}
  #     - DISPLAY_HEIGHT=${MAKEMKV_HEIGHT-:768}
  #     - SECURE_CONNECTION=0
  #     - CLEAN_TMP_DIR=1
  #   labels:
  #     - "${TANGO_INSTANCE_NAME}.managed=true"
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.makemkv.entrypoints=${MAKEMKV_ENTRYPOINTS:-web_main}"
  #     - "traefik.http.routers.makemkv.rule=HostRegexp(`{subdomain:${MAKEMKV_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
  #     - "traefik.http.routers.makemkv.priority=${MAKEMKV_PRIORITY}"
  #     - "traefik.http.routers.makemkv.service=makemkv"
  #     - "traefik.http.routers.makemkv-secure.entrypoints=${MAKEMKV_ENTRYPOINTS_SECURE:-web_main_secure}"
  #     - "traefik.http.routers.makemkv-secure.rule=HostRegexp(`{subdomain:${MAKEMKV_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
  #     - "traefik.http.routers.makemkv-secure.priority=${MAKEMKV_PRIORITY}"
  #     - "traefik.http.routers.makemkv-secure.service=makemkv"
  #     - "traefik.http.routers.makemkv-secure.tls=true"
  #     - "traefik.http.routers.makemkv-secure.tls.domains[0].main=${MAKEMKV_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
  #     - "traefik.http.services.makemkv.loadbalancer.server.port=5800"
  #     - "traefik.http.services.makemkv.loadbalancer.server.scheme=http"
  #     - "traefik.http.services.makemkv.loadbalancer.passhostheader=true"
  #     - "traefik.http.routers.makemkv.middlewares=makemkv-auth@rest,error-middleware"
  #     - "traefik.http.routers.makemkv-secure.middlewares=makemkv-auth@rest,error-middleware"
  #   networks:
  #     - default
  #   expose:
  #     - 5800/tcp


  # web area
  web:
    image: bitnami/apache:${WEB_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_web
    user: 0:0
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      - web_data:/app/web
      # allow to expose books cover
      - calibredb_books_media:/app/calibredb/books
      - calibredb_press_media:/app/calibredb/press
      - ${TANGO_APP_ROOT}/pool/ebooks/calibredb_cover.htaccess:/app/calibredb/.htaccess
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service : web
      - "traefik.http.services.web.loadbalancer.server.port=8080"
      - "traefik.http.services.web.loadbalancer.server.scheme=http"
      - "traefik.http.services.web.loadbalancer.passhostheader=true"
      # sub service web_site
      - "traefik.http.routers.web_site.entrypoints=${WEB_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.web_site.rule=HostRegexp(`{subdomain:${WEB_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.web_site.priority=${WEB_SITE_PRIORITY}"
      - "traefik.http.routers.web_site.service=web"
      - "traefik.http.routers.web_site-secure.entrypoints=${WEB_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.web_site-secure.rule=HostRegexp(`{subdomain:${WEB_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.web_site-secure.priority=${WEB_SITE_PRIORITY}"
      - "traefik.http.routers.web_site-secure.service=web"
      - "traefik.http.routers.web_site-secure.tls=true"
      - "traefik.http.routers.web_site-secure.tls.domains[0].main=${WEB_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # sub service router
      - "traefik.http.routers.web_site.middlewares=error-middleware"
      - "traefik.http.routers.web_site-secure.middlewares=error-middleware"
      # sub service web_newsletter
      - "traefik.http.routers.web_newsletter.entrypoints=${WEB_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.web_newsletter.rule=HostRegexp(`{subdomain:${WEB_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && (PathPrefix(`/image`) || PathPrefix(`/newsletter`))"
      - "traefik.http.routers.web_newsletter.priority=${WEB_NEWSLETTER_PRIORITY}"
      - "traefik.http.routers.web_newsletter.service=tautulli"
      - "traefik.http.routers.web_newsletter-secure.entrypoints=${WEB_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.web_newsletter-secure.rule=HostRegexp(`{subdomain:${WEB_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`) && (PathPrefix(`/image`) || PathPrefix(`/newsletter`))"
      - "traefik.http.routers.web_newsletter-secure.priority=${WEB_NEWSLETTER_PRIORITY}"
      - "traefik.http.routers.web_newsletter-secure.service=tautulli"
      - "traefik.http.routers.web_newsletter-secure.tls=true"
      - "traefik.http.routers.web_newsletter-secure.tls.domains[0].main=${WEB_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # sub service router
      - "traefik.http.routers.web_newsletter.middlewares=error-middleware"
      - "traefik.http.routers.web_newsletter-secure.middlewares=error-middleware"
    networks:
      - default
    expose:
      - 8080


  # ebook newsletter
  # not exposed through traefik
  ebooks_list:
    image: studioetrange/ebooks-list:latest
    container_name: ${TANGO_APP_NAME}_ebooks_list
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      - ebooks_list_data:/config
      - calibredb_books_media:/calibredb/books
      - calibredb_press_media:/calibredb/press
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - DOCKER_MODS=studioetrange/calibre-mod:${CALIBRE_MOD_VERSION:-latest}
      # data used inside template
      - 'URL_CALIBREDB_FOR_COVER=${WEB_HTTP_URL_DEFAULT_SECURE}'
      - 'URL_BOOK_LINK=${ORGANIZR2_HTTP_URL_DEFAULT_SECURE}/#Books'
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
    networks:
      - default
    expose:
      - 9000
    build:
      context: ./pool/artefacts/docker-ebooks-list


  # Audiobook and podcast streamer
  # https://booksonic.org/
  # https://github.com/popeen/Booksonic-Air
  # https://hub.docker.com/r/linuxserver/booksonic-air
  # https://github.com/linuxserver/docker-booksonic-air
  booksonic:
    image: linuxserver/booksonic-air:${BOOKSONIC_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_booksonic
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      - booksonic_data:/config
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - CONTEXT_PATH=/
      # FIX https/http mixed content error into web browser
      # https://github.com/popeen/Booksonic-Air/issues/23
      - "JAVA_OPTS=-Dserver.use-forward-headers=true"
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.booksonic.loadbalancer.server.port=4040"
      - "traefik.http.services.booksonic.loadbalancer.server.scheme=http"
      - "traefik.http.services.booksonic.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.booksonic.entrypoints=${BOOKSONIC_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.booksonic.rule=HostRegexp(`{subdomain:${BOOKSONIC_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.booksonic.priority=${BOOKSONIC_PRIORITY}"
      - "traefik.http.routers.booksonic.service=booksonic"
      - "traefik.http.routers.booksonic-secure.entrypoints=${BOOKSONIC_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.booksonic-secure.rule=HostRegexp(`{subdomain:${BOOKSONIC_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.booksonic-secure.priority=${BOOKSONIC_PRIORITY}"
      - "traefik.http.routers.booksonic-secure.service=booksonic"
      - "traefik.http.routers.booksonic-secure.tls=true"
      - "traefik.http.routers.booksonic-secure.tls.domains[0].main=${BOOKSONIC_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      - "traefik.http.routers.booksonic.middlewares=booksonic-auth@rest,error-middleware"
      - "traefik.http.routers.booksonic-secure.middlewares=booksonic-auth@rest,error-middleware"
      # airsonic (and booksonic) cannot be correctly print into an iframe
      #     https://github.com/airsonic/airsonic/issues/583
      #     airsonic fix an X-Frame-Options to SAMEORIGIN to not allow be print into an iframe
      #     we can override this with the middleware xframe-allow-all
      #     but it do not really work well
    networks:
      - default
    expose:
      - 4040/tcp
  # direct download manager
  # https://github.com/PlusMinus0/headless-jd2-docker
  jdownloader2:
    image: plusminus/jdownloader2-headless:${JDOWNLOADER2_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_jdownloader2
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      - jdownloader2_download:/opt/JDownloader/Downloads
      - jdownloader2_data:/opt/JDownloader/cfg
    environment:
      - UID=${TANGO_USER_ID:-0}
      - GID=${TANGO_GROUP_ID:-0}
      - EMAIL=${JDOWNLOADER2_EMAIL:-}
      - PASSWORD=${JDOWNLOADER2_PASSWORD:-}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=false"
    networks:
      - default


  # Lazylibrarian
  # https://github.com/linuxserver/docker-lazylibrarian
  # https://hub.docker.com/r/linuxserver/lazylibrarian
  lazylibrarian:
    image: ghcr.io/linuxserver/lazylibrarian:${LAZYLIBRARIAN_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_lazylibrarian
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain lazylibrarian configuration
      - lazylibrarian_data:/config
      # different paths used by lazylibrarian
      - download:/download
      - calibredb_books_media:/calibredb/books
      - calibredb_press_media:/calibredb/press
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.lazylibrarian.loadbalancer.server.port=5299"
      - "traefik.http.services.lazylibrarian.loadbalancer.server.scheme=http"
      - "traefik.http.services.lazylibrarian.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.lazylibrarian.entrypoints=${LAZYLIBRARIAN_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.lazylibrarian.rule=HostRegexp(`{subdomain:${LAZYLIBRARIAN_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.lazylibrarian.priority=${LAZYLIBRARIAN_PRIORITY}"
      - "traefik.http.routers.lazylibrarian.service=lazylibrarian"
      - "traefik.http.routers.lazylibrarian-secure.entrypoints=${LAZYLIBRARIAN_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.lazylibrarian-secure.rule=HostRegexp(`{subdomain:${LAZYLIBRARIAN_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.lazylibrarian-secure.priority=${LAZYLIBRARIAN_PRIORITY}"
      - "traefik.http.routers.lazylibrarian-secure.service=lazylibrarian"
      - "traefik.http.routers.lazylibrarian-secure.tls=true"
      - "traefik.http.routers.lazylibrarian-secure.tls.domains[0].main=${LAZYLIBRARIAN_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.lazylibrarian.middlewares=lazylibrarian-auth@rest,error-middleware"
      - "traefik.http.routers.lazylibrarian-secure.middlewares=lazylibrarian-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 5299/tcp


  # Calibre
  # https://github.com/linuxserver/docker-calibre
  # https://github.com/kovidgoyal/calibre
  calibre:
    image: ghcr.io/linuxserver/calibre:${CALIBRE_VERSION:-latest}
    container_name: ${TANGO_APP_NAME}_calibre
    depends_on:
      - service_init
    restart: unless-stopped
    volumes:
      # will contain calibre configuration
      - calibre_data:/config
      # different paths used by calibre
      - download:/download
      - calibredb_books_media:/calibredb/books
      - calibredb_press_media:/calibredb/press
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.calibre.loadbalancer.server.port=8080"
      - "traefik.http.services.calibre.loadbalancer.server.scheme=http"
      - "traefik.http.services.calibre.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.calibre.entrypoints=${CALIBRE_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.calibre.rule=HostRegexp(`{subdomain:${CALIBRE_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibre.priority=${CALIBRE_PRIORITY}"
      - "traefik.http.routers.calibre.service=calibre"
      - "traefik.http.routers.calibre-secure.entrypoints=${CALIBRE_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.calibre-secure.rule=HostRegexp(`{subdomain:${CALIBRE_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibre-secure.priority=${CALIBRE_PRIORITY}"
      - "traefik.http.routers.calibre-secure.service=calibre"
      - "traefik.http.routers.calibre-secure.tls=true"
      - "traefik.http.routers.calibre-secure.tls.domains[0].main=${CALIBRE_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.calibre.middlewares=calibre-auth@rest,error-middleware"
      - "traefik.http.routers.calibre-secure.middlewares=calibre-auth@rest,error-middleware"
    networks:
      - default
    expose:
      - 8080/tcp


  calibreweb_books:
    !!merge <<: *default-calibreweb
    container_name: ${TANGO_APP_NAME}_calibreweb_books
    volumes:
      # will contain calibre-web configuration
      - calibreweb_books_data:/config
      # different paths used by calibreweb
      - download:/download
      - calibredb_books_media:/books
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - DOCKER_MODS=studioetrange/calibre-mod:${CALIBRE_MOD_VERSION:-latest}
      - AUTO_CREATE_DB=/books
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.calibreweb_books.loadbalancer.server.port=8083"
      - "traefik.http.services.calibreweb_books.loadbalancer.server.scheme=http"
      - "traefik.http.services.calibreweb_books.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.calibreweb_books.entrypoints=${CALIBREWEB_BOOKS_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.calibreweb_books.rule=HostRegexp(`{subdomain:${CALIBREWEB_BOOKS_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibreweb_books.priority=${CALIBREWEB_BOOKS_PRIORITY}"
      - "traefik.http.routers.calibreweb_books.service=calibreweb_books"
      - "traefik.http.routers.calibreweb_books-secure.entrypoints=${CALIBREWEB_BOOKS_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.calibreweb_books-secure.rule=HostRegexp(`{subdomain:${CALIBREWEB_BOOKS_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibreweb_books-secure.priority=${CALIBREWEB_BOOKS_PRIORITY}"
      - "traefik.http.routers.calibreweb_books-secure.service=calibreweb_books"
      - "traefik.http.routers.calibreweb_books-secure.tls=true"
      - "traefik.http.routers.calibreweb_books-secure.tls.domains[0].main=${CALIBREWEB_BOOKS_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.calibreweb_books.middlewares=calibreweb_books-auth@rest,xframe-allow-all,error-middleware"
      - "traefik.http.routers.calibreweb_books-secure.middlewares=calibreweb_books-auth@rest,xframe-allow-all,error-middleware"
  

  
  calibreweb_press:
    !!merge <<: *default-calibreweb
    container_name: ${TANGO_APP_NAME}_calibreweb_press
    volumes:
      # will contain calibre-web configuration
      - calibreweb_press_data:/config
      # different paths used by calibreweb
      - download:/download
      - calibredb_press_media:/press
    environment:
      - PUID=${TANGO_USER_ID:-0}
      - PGID=${TANGO_GROUP_ID:-0}
      - DOCKER_MODS=studioetrange/calibre-mod:${CALIBRE_MOD_VERSION:-latest}
      - AUTO_CREATE_DB=/press
    labels:
      - "${TANGO_INSTANCE_NAME}.managed=true"
      - "traefik.enable=true"
      # service
      - "traefik.http.services.calibreweb_press.loadbalancer.server.port=8083"
      - "traefik.http.services.calibreweb_press.loadbalancer.server.scheme=http"
      - "traefik.http.services.calibreweb_press.loadbalancer.passhostheader=true"
      # routers
      - "traefik.http.routers.calibreweb_press.entrypoints=${CALIBREWEB_PRESS_ENTRYPOINTS:-web_main}"
      - "traefik.http.routers.calibreweb_press.rule=HostRegexp(`{subdomain:${CALIBREWEB_PRESS_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibreweb_press.priority=${CALIBREWEB_PRESS_PRIORITY}"
      - "traefik.http.routers.calibreweb_press.service=calibreweb_press"
      - "traefik.http.routers.calibreweb_press-secure.entrypoints=${CALIBREWEB_PRESS_ENTRYPOINTS_SECURE:-web_main_secure}"
      - "traefik.http.routers.calibreweb_press-secure.rule=HostRegexp(`{subdomain:${CALIBREWEB_PRESS_SUBDOMAIN}}{domain:${TANGO_DOMAIN:-.*}}`)"
      - "traefik.http.routers.calibreweb_press-secure.priority=${CALIBREWEB_PRESS_PRIORITY}"
      - "traefik.http.routers.calibreweb_press-secure.service=calibreweb_press"
      - "traefik.http.routers.calibreweb_press-secure.tls=true"
      - "traefik.http.routers.calibreweb_press-secure.tls.domains[0].main=${CALIBREWEB_PRESS_SUBDOMAIN}${TANGO_DOMAIN:-.*}"
      # routers middleware
      - "traefik.http.routers.calibreweb_press.middlewares=calibreweb_press-auth@rest,xframe-allow-all,error-middleware"
      - "traefik.http.routers.calibreweb_press-secure.middlewares=calibreweb_press-auth@rest,xframe-allow-all,error-middleware"
  